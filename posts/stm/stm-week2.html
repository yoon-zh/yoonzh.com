<!-- _layouts/default.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- _includes/head.html -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <title>STM Week 2: Clock & Power Management - yoonzh.com</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Ïú§Âøó" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#0a0a0a" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0a0a0a" />
  <link rel="manifest" href="/site.webmanifest" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>
  
  
</head>
</head>
<body class="">
  <!-- _includes/header.html -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K2M9QVQ44D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K2M9QVQ44D');
</script>

<header class="site-header">
  <div class="nav-container">
    <div class="logo-group">
      <a href="/" class="logo-image">
        <img src="/images/pepito-square.jpg" alt="Home">
      </a>
      <div class="logo-container">
        <a href="/" class="logo-link">
          <h1 class="logo">Ïú§Âøó</h1>
        </a>
        <p class="logo-subtitle">[‰∫ë ~ Ï∞å]</p>
      </div>
    </div>
    <nav class="nav-links">
      
        <a href="/projects/" class="hover-glow">Projects</a>
      
        <a href="/posts/" class="hover-glow">Posts</a>
      
        <a href="/about/" class="hover-glow">About</a>
      
    </nav>
  </div>
</header>
  
  <main class="page-content">
    <!-- _layouts/post.html -->
<article class="article-detail">
  <!-- _includes/article-content.html -->
<header class="article-header">
  <h1>
    STM Week 2: Clock & Power Management
    
  </h1>
  
  <div class="tech-tags">
    
      <span class="tech-tag">STM</span>
    
  </div>
  
  <div class="article-meta">
    
      <time datetime="2025-03-07T00:00:00+00:00">
        üìÖ 2025/03/07
      </time>
    
  </div>
</header>

<div class="article-content">
  <p><em>Adapted from <sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></em></p>

<h1 id="concepts">Concepts</h1>

<h2 id="1-clock-sources">1. Clock Sources</h2>

<h3 id="a-hsi-high-speed-internal-oscillator">a. HSI (High-Speed Internal Oscillator)</h3>
<ul>
  <li>16 MHz RC oscillator. Low accuracy (¬±1%) but requires no external components</li>
  <li>Used as a fallback if HSE fails</li>
</ul>

<h3 id="b-hse-high-speed-external-oscillator">b. HSE (High-Speed External Oscillator)</h3>
<ul>
  <li>External crystal (4‚Äì26 MHz). High accuracy (¬±0.1%)</li>
  <li>Required for achieving maximum clock speeds (e.g., 168 MHz)</li>
</ul>

<h3 id="c-pll-phase-locked-loop">c. PLL (Phase-Locked Loop)</h3>
<ul>
  <li>Multiplies HSE/HSI frequency. Example: HSE (8 MHz) ‚Üí PLL (√ó21) ‚Üí 168 MHz</li>
  <li>Divided into PLLM (input divider), PLLN (multiplier), and PLLP (output divider)</li>
</ul>

<h2 id="2-power-modes">2. Power Modes</h2>
<ol>
  <li><strong>Run Mode</strong>: Full power (CPU, peripherals active)</li>
  <li><strong>Sleep Mode</strong>: CPU halted, peripherals active. Wake via interrupts</li>
  <li><strong>Stop Mode</strong>: Core voltage domain powered off. Wake via external interrupts or RTC</li>
</ol>

<h2 id="3-clock-tree-analysis">3. Clock Tree Analysis</h2>
<ul>
  <li><strong>SYSCLK</strong>: System clock (max 168 MHz). Sources: HSI, HSE, PLL</li>
  <li><strong>AHB Prescaler</strong>: Divides SYSCLK for AHB bus (e.g., 168 MHz ‚Üí 168 MHz)</li>
  <li><strong>APB1/APB2 Prescalers</strong>: Divides AHB for peripherals (APB1 max 42 MHz, APB2 max 84 MHz)</li>
</ul>

<h3 id="example-code">Example Code</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// system_stm32f4xx.c (auto-generated by STM32CubeMX)</span>
<span class="kt">void</span> <span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">RCC_OscInitTypeDef</span> <span class="n">RCC_OscInitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="n">RCC_ClkInitTypeDef</span> <span class="n">RCC_ClkInitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

  <span class="c1">// Configure HSE (8 MHz) ‚Üí PLL ‚Üí 168 MHz</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">OscillatorType</span> <span class="o">=</span> <span class="n">RCC_OSCILLATORTYPE_HSE</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSEState</span> <span class="o">=</span> <span class="n">RCC_HSE_ON</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLState</span> <span class="o">=</span> <span class="n">RCC_PLL_ON</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLSource</span> <span class="o">=</span> <span class="n">RCC_PLLSOURCE_HSE</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLM</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>     <span class="c1">// HSE (8 MHz) / 8 = 1 MHz</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLN</span> <span class="o">=</span> <span class="mi">336</span><span class="p">;</span>   <span class="c1">// 1 MHz √ó 336 = 336 MHz</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>      <span class="c1">// 336 MHz / 2 = 168 MHz (SYSCLK)</span>
  <span class="n">HAL_RCC_OscConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_OscInitStruct</span><span class="p">);</span>

  <span class="c1">// Configure clock dividers</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">ClockType</span> <span class="o">=</span> <span class="n">RCC_CLOCKTYPE_SYSCLK</span> <span class="o">|</span> <span class="n">RCC_CLOCKTYPE_HCLK</span> <span class="o">|</span>
                                <span class="n">RCC_CLOCKTYPE_PCLK1</span> <span class="o">|</span> <span class="n">RCC_CLOCKTYPE_PCLK2</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">SYSCLKSource</span> <span class="o">=</span> <span class="n">RCC_SYSCLKSOURCE_PLLCLK</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">AHBCLKDivider</span> <span class="o">=</span> <span class="n">RCC_SYSCLK_DIV1</span><span class="p">;</span>     <span class="c1">// 168 MHz</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB1CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV4</span><span class="p">;</span>      <span class="c1">// 42 MHz</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB2CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV2</span><span class="p">;</span>      <span class="c1">// 84 MHz</span>
  <span class="n">HAL_RCC_ClockConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_ClkInitStruct</span><span class="p">,</span> <span class="n">FLASH_LATENCY_5</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="questions">Questions</h2>

<ol>
  <li>What happens if APB1‚Äôs clock exceeds 42 MHz?</li>
  <li>How does Stop mode differ from Sleep mode?</li>
  <li>If HSE fails, which clock source does the STM32 use?</li>
</ol>

<hr />

<h1 id="project-setting-stm-clock-speed">Project: Setting STM Clock Speed</h1>
<p>Configure the STM32 to run at 168 MHz using STM32CubeMX. Validate timing accuracy using <code class="language-text highlighter-rouge">bsp_delay.c</code> and an oscilloscope.</p>

<h2 id="steps">Steps</h2>
<ol>
  <li>Clock Configuration:
    <ul>
      <li>Set HSE as the clock source</li>
      <li>Configure PLL to generate 168 MHz</li>
      <li>Adjust AHB/APB prescalers for safe peripheral operation</li>
    </ul>
  </li>
  <li>Delay Module: Use <code class="language-text highlighter-rouge">bsp_delay.c</code> to create a 1 Hz signal (500 ms high, 500 ms low) on a GPIO pin</li>
  <li>Measure the GPIO pin‚Äôs frequency with an oscilloscope (expected: 1 Hz ¬±1%)</li>
</ol>

<hr />

<h2 id="walkthrough">Walkthrough</h2>

<h3 id="step-1-configure-clock-in-stm32cubemx">Step 1: Configure Clock in STM32CubeMX</h3>
<ol>
  <li>Open STM32CubeMX ‚Üí New Project &gt; Select your STM32F4 MCU</li>
  <li><strong>Clock Configuration Tab</strong>:
    <ul>
      <li>Set <strong>HSE</strong> to ‚ÄúCrystal/Ceramic Resonator‚Äù (assumes 8 MHz external crystal)</li>
      <li>Set <strong>PLL Source Mux</strong> to HSE</li>
      <li>Configure <strong>PLLM</strong> = 8, <strong>PLLN</strong> = 336, <strong>PLLP</strong> = 2 ‚Üí SYSCLK = 168 MHz</li>
      <li>Set <strong>AHB Prescaler</strong> = 1 (168 MHz), <strong>APB1</strong> = 4 (42 MHz), <strong>APB2</strong> = 2 (84 MHz)</li>
    </ul>
  </li>
  <li>Generate code with ‚ÄúProject ‚Üí Generate Code‚Äù</li>
</ol>

<h3 id="step-2-implement-delay-module">Step 2: Implement Delay Module</h3>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// bsp_delay.c  </span>
<span class="cp">#include</span> <span class="cpf">"stm32f4xx_hal.h"</span><span class="c1">  </span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">delay_ms</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">ms</span><span class="p">)</span> <span class="p">{</span>  
  <span class="kt">uint32_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">HAL_GetTick</span><span class="p">();</span>  
  <span class="k">while</span> <span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="p">);</span>  
<span class="p">}</span>  

<span class="c1">// main.c  </span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>  
  <span class="n">HAL_Init</span><span class="p">();</span>  
  <span class="n">SystemClock_Config</span><span class="p">();</span>  
  <span class="n">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="p">();</span>  
  <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>  
  <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_5</span><span class="p">;</span>  
  <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">;</span>  
  <span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>  

  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="n">GPIO_PIN_5</span><span class="p">);</span>  
    <span class="n">delay_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  
  <span class="p">}</span>  
<span class="p">}</span>  
</code></pre></div></div>

<h3 id="step-3-oscilloscope-verification">Step 3: Oscilloscope Verification</h3>
<ul>
  <li>Connect the oscilloscope probe to GPIO Pin PA5</li>
  <li>Measure period: Should be 1 sec (500 ms high + 500 ms low)</li>
  <li>If timing is incorrect, check PLL settings and <code class="language-text highlighter-rouge">HAL_RCC_ClockConfig()</code> in <code class="language-text highlighter-rouge">system_stm32f4xx.c</code></li>
</ul>

<hr />

<h2 id="debugging">Debugging</h2>

<p><strong>GPIO toggle is too slow</strong></p>
<ul>
  <li>Verify <code class="language-text highlighter-rouge">SystemCoreClock</code> in <code class="language-text highlighter-rouge">system_stm32f4xx.c</code> is 168000000</li>
</ul>

<p><strong>Code crashes after clock configuration</strong></p>
<ul>
  <li>Ensure <strong>Flash Latency</strong> is set to 5 wait states (required for 168 MHz)</li>
</ul>

<p><strong>No signal on oscilloscope</strong></p>
<ul>
  <li>Confirm GPIO pin is configured as output and oscilloscope ground is connected.</li>
</ul>

<h2 id="dictionary">Dictionary</h2>

<ul>
  <li><strong>HSI/HSE</strong>: Internal/external clock sources</li>
  <li><strong>PLL</strong>: Clock multiplier for higher frequencies</li>
  <li><strong>SYSCLK</strong>: Primary system clock</li>
  <li><strong>AHB/APB</strong>: Buses for peripherals and memory</li>
  <li><strong>Prescaler</strong>: Divides clock frequency</li>
</ul>

<h2 id="resources">Resources</h2>

<ol>
  <li><a href="https://www.st.com/resource/en/application_note/an4776-generalpurpose-timer-cookbook-for-stm32-microcontrollers-stmicroelectronics.pdf">STM32 Clock Configuration Guide</a></li>
  <li><a href="https://community.st.com/t5/stm32-mcus/part-1-introduction-to-the-stm32-microcontroller-clock-system/ta-p/605369">STM32 Clock System Introduction</a></li>
  <li><a href="https://www.youtube.com/watch?v=hUIgAu3QQWQ">Oscilloscope Basics Tutorial</a></li>
  <li><a href="https://www.youtube.com/playlist?list=PL746BF38BC2E068E0">Everything about Oscilloscopes Playlist</a></li>
</ol>

<h2 id="answers-to-questions">Answers to Questions</h2>

<ol>
  <li>Peripheral registers may corrupt, leading to undefined behavior</li>
  <li>Stop mode turns off the core voltage domain, reducing power further but requiring longer wake-up time</li>
  <li>HSI (16 MHz)</li>
</ol>

<hr />

<h2 id="credits">Credits</h2>

<!--Written by Jorge Porras (2025)-->
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Deepseek.¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</div>
</article>
  </main>

  <!-- _includes/footer.html -->
<footer class="site-footer">
  <div class="footer-content">
    <div class="social-links">
      <a href="https://github.com/yoon-zh" class="hover-glow" aria-label="GitHub">
        <i class="fab fa-github"></i>
      </a>
      <a href="mailto:yoon_zh@outlook.com" class="hover-glow" aria-label="Email">
        <i class="fas fa-envelope"></i>
      </a>
      <a href="https://www.linkedin.com/in/jorge-porras-1a7393282/" class="hover-glow" aria-label="LinkedIn">
        <i class="fab fa-linkedin"></i>
      </a>
      <a href="https://t.me/yo_o_n" class="hover-glow" aria-label="Telegram">
        <i class="fab fa-telegram-plane"></i>
      </a>
    </div>
    <div class="footer-bottom">
      <p>¬© 2025 Ïú§Âøó. All rights reserved.</p>
    </div>
  </div>
</footer>
<script src="/scripts/main.js"></script>
<script src="/scripts/codeblocks.js"></script>
<script src="/scripts/axeptio.js"></script>
</body>
</html>
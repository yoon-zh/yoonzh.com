<!-- _layouts/default.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- _includes/head.html -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <title>yoonzh.com</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>
  
</head>
</head>
<body class="">
  <!-- _includes/header.html -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K2M9QVQ44D"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K2M9QVQ44D');
</script>

<header class="site-header">
  <div class="nav-container">
    <div class="logo-container">
      <a href="/" class="logo-link">
        <h1 class="logo">윤志</h1>
      </a>
      <p class="logo-subtitle">[云 ~ 찌]</p>
    </div>
    <nav class="nav-links">
      
        <a href="/projects/" class="hover-glow">Projects</a>
      
        <a href="/posts/" class="hover-glow">Posts</a>
      
        <a href="/about/" class="hover-glow">About</a>
      
    </nav>
  </div>
</header>
  
  <main class="page-content">
    <!-- _layouts/post.html -->
<article class="article-detail">
  <!-- _includes/article-content.html -->
<header class="article-header">
  <h1>
    stm week 3
    
  </h1>
  
  <div class="tech-tags">
    
      <span class="tech-tag">C/C++</span>
    
  </div>
  
  <div class="article-meta">
    
  </div>
</header>

<div class="article-content">
  <p>date: 2025-03-01</p>

<p><em>Adapted from <sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></em></p>

<h1 id="week-3-halll-libraries">Week 3: HAL/LL Libraries</h1>

<h2 id="concepts">Concepts</h2>

<h3 id="1-clock-sources">1. Clock Sources</h3>
<p><strong>HSI (High-Speed Internal Oscillator)</strong>:</p>
<ul>
  <li>16 MHz RC oscillator. Low accuracy (±1%) but requires no external components.</li>
  <li>Used as a fallback if HSE fails.
    <ol>
      <li><strong>HSE (High-Speed External Oscillator)</strong>:</li>
    </ol>
    <ul>
      <li>External crystal (4–26 MHz). High accuracy (±0.1%).</li>
      <li>Required for achieving maximum clock speeds (e.g., 168 MHz).
        <ol>
          <li><strong>PLL (Phase-Locked Loop)</strong>:</li>
        </ol>
      </li>
      <li>Multiplies HSE/HSI frequency. Example: HSE (8 MHz) → PLL (×21) → 168 MHz.</li>
      <li>Divided into <strong>PLLM</strong> (input divider), <strong>PLLN</strong> (multiplier), and <strong>PLLP</strong> (output divider).</li>
    </ul>
  </li>
</ul>

<h2 id="questions">Questions</h2>

<h2 id="project">Project:</h2>

<h3 id="walkthrough">Walkthrough</h3>

<h3 id="debugging">Debugging</h3>

<h2 id="dictionary">Dictionary</h2>

<h2 id="resources">Resources</h2>

<h2 id="answers-to-questions">Answers to Questions</h2>

<h3 id="power-modes"><strong>Power Modes</strong></h3>
<ol>
  <li><strong>Run Mode</strong>: Full power (CPU, peripherals active).</li>
  <li><strong>Sleep Mode</strong>: CPU halted, peripherals active. Wake via interrupts.</li>
  <li><strong>Stop Mode</strong>: Core voltage domain powered off. Wake via external interrupts or RTC.</li>
</ol>

<h3 id="clock-tree-analysis"><strong>Clock Tree Analysis</strong></h3>
<ul>
  <li><strong>SYSCLK</strong>: System clock (max 168 MHz). Sources: HSI, HSE, PLL.</li>
  <li><strong>AHB Prescaler</strong>: Divides SYSCLK for AHB bus (e.g., 168 MHz → 168 MHz).</li>
  <li><strong>APB1/APB2 Prescalers</strong>: Divides AHB for peripherals (APB1 max 42 MHz, APB2 max 84 MHz).</li>
</ul>

<p><strong>Example Code</strong></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// system_stm32f4xx.c (auto-generated by STM32CubeMX)  </span>
<span class="kt">void</span> <span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>  
  <span class="n">RCC_OscInitTypeDef</span> <span class="n">RCC_OscInitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>  
  <span class="n">RCC_ClkInitTypeDef</span> <span class="n">RCC_ClkInitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>  

  <span class="c1">// Configure HSE (8 MHz) → PLL → 168 MHz  </span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">OscillatorType</span> <span class="o">=</span> <span class="n">RCC_OSCILLATORTYPE_HSE</span><span class="p">;</span>  
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSEState</span> <span class="o">=</span> <span class="n">RCC_HSE_ON</span><span class="p">;</span>  
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLState</span> <span class="o">=</span> <span class="n">RCC_PLL_ON</span><span class="p">;</span>  
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLSource</span> <span class="o">=</span> <span class="n">RCC_PLLSOURCE_HSE</span><span class="p">;</span>  
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLM</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>     <span class="c1">// HSE (8 MHz) / 8 = 1 MHz  </span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLN</span> <span class="o">=</span> <span class="mi">336</span><span class="p">;</span>   <span class="c1">// 1 MHz × 336 = 336 MHz  </span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLP</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>      <span class="c1">// 336 MHz / 2 = 168 MHz (SYSCLK)  </span>
  <span class="n">HAL_RCC_OscConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_OscInitStruct</span><span class="p">);</span>  

  <span class="c1">// Configure clock dividers  </span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">ClockType</span> <span class="o">=</span> <span class="n">RCC_CLOCKTYPE_SYSCLK</span> <span class="o">|</span> <span class="n">RCC_CLOCKTYPE_HCLK</span> <span class="o">|</span>  
                                <span class="n">RCC_CLOCKTYPE_PCLK1</span> <span class="o">|</span> <span class="n">RCC_CLOCKTYPE_PCLK2</span><span class="p">;</span>  
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">SYSCLKSource</span> <span class="o">=</span> <span class="n">RCC_SYSCLKSOURCE_PLLCLK</span><span class="p">;</span>  
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">AHBCLKDivider</span> <span class="o">=</span> <span class="n">RCC_SYSCLK_DIV1</span><span class="p">;</span>     <span class="c1">// 168 MHz  </span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB1CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV4</span><span class="p">;</span>      <span class="c1">// 42 MHz  </span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB2CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV2</span><span class="p">;</span>      <span class="c1">// 84 MHz  </span>
  <span class="n">HAL_RCC_ClockConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_ClkInitStruct</span><span class="p">,</span> <span class="n">FLASH_LATENCY_5</span><span class="p">);</span>  
<span class="p">}</span>  
</code></pre></div></div>

<hr />

<p><strong>Project</strong></p>

<p><strong>Objective</strong>: Configure the STM32 to run at 168 MHz using STM32CubeMX. Validate timing accuracy using <code class="language-text highlighter-rouge">bsp_delay.c</code> and an oscilloscope.</p>

<p><strong>Steps</strong>:</p>
<ol>
  <li><strong>Clock Configuration</strong>:
    <ul>
      <li>Set HSE as the clock source.</li>
      <li>Configure PLL to generate 168 MHz.</li>
      <li>Adjust AHB/APB prescalers for safe peripheral operation.</li>
    </ul>
  </li>
  <li><strong>Delay Module</strong>:
    <ul>
      <li>Use <code class="language-text highlighter-rouge">bsp_delay.c</code> to create a 1 Hz signal (500 ms high, 500 ms low) on a GPIO pin.</li>
    </ul>
  </li>
  <li><strong>Verification</strong>:
    <ul>
      <li>Measure the GPIO pin’s frequency with an oscilloscope (expected: 1 Hz ±1%).</li>
    </ul>
  </li>
</ol>

<p><strong>Deliverables</strong>:</p>
<ul>
  <li>STM32CubeMX project file (.ioc).</li>
  <li>GitHub repository with code and oscilloscope screenshot.</li>
</ul>

<hr />

<h2 id="walkthrough-1"><strong>Walkthrough</strong></h2>
<h3 id="step-1-configure-clock-in-stm32cubemx"><strong>Step 1: Configure Clock in STM32CubeMX</strong></h3>
<ol>
  <li>Open STM32CubeMX → New Project → Select your STM32F4 MCU.</li>
  <li><strong>Clock Configuration Tab</strong>:
    <ul>
      <li>Set <strong>HSE</strong> to “Crystal/Ceramic Resonator” (assumes 8 MHz external crystal).</li>
      <li>Set <strong>PLL Source Mux</strong> to HSE.</li>
      <li>Configure <strong>PLLM</strong> = 8, <strong>PLLN</strong> = 336, <strong>PLLP</strong> = 2 → SYSCLK = 168 MHz.</li>
      <li>Set <strong>AHB Prescaler</strong> = 1 (168 MHz), <strong>APB1</strong> = 4 (42 MHz), <strong>APB2</strong> = 2 (84 MHz).</li>
    </ul>
  </li>
  <li>Generate code with “Project → Generate Code”.</li>
</ol>

<h3 id="step-2-implement-delay-module"><strong>Step 2: Implement Delay Module</strong></h3>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// bsp_delay.c  </span>
<span class="cp">#include</span> <span class="cpf">"stm32f4xx_hal.h"</span><span class="c1">  </span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">delay_ms</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">ms</span><span class="p">)</span> <span class="p">{</span>  
  <span class="kt">uint32_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">HAL_GetTick</span><span class="p">();</span>  
  <span class="k">while</span> <span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="p">);</span>  
<span class="p">}</span>  

<span class="c1">// main.c  </span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>  
  <span class="n">HAL_Init</span><span class="p">();</span>  
  <span class="n">SystemClock_Config</span><span class="p">();</span>  
  <span class="n">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="p">();</span>  
  <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>  
  <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_5</span><span class="p">;</span>  
  <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">;</span>  
  <span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>  

  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">HAL_GPIO_TogglePin</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="n">GPIO_PIN_5</span><span class="p">);</span>  
    <span class="n">delay_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>  
  <span class="p">}</span>  
<span class="p">}</span>  
</code></pre></div></div>

<h3 id="step-3-oscilloscope-verification"><strong>Step 3: Oscilloscope Verification</strong></h3>
<ul>
  <li>Connect the oscilloscope probe to GPIO Pin PA5.</li>
  <li>Measure period: Should be 1 sec (500 ms high + 500 ms low).</li>
  <li>If timing is incorrect, check PLL settings and <code class="language-text highlighter-rouge">HAL_RCC_ClockConfig()</code> in <code class="language-text highlighter-rouge">system_stm32f4xx.c</code>.</li>
</ul>

<hr />

<h2 id="quizzes"><strong>Quizzes</strong></h2>
<ol>
  <li>
    <p><strong>Q</strong>: What happens if APB1’s clock exceeds 42 MHz?<br />
<strong>A</strong>: Peripheral registers may corrupt, leading to undefined behavior.</p>
  </li>
  <li>
    <p><strong>Q</strong>: How does Stop mode differ from Sleep mode?<br />
<strong>A</strong>: Stop mode turns off the core voltage domain, reducing power further but requiring longer wake-up time.</p>
  </li>
  <li>
    <p><strong>Q</strong>: If HSE fails, which clock source does the STM32 use?<br />
<strong>A</strong>: HSI (16 MHz).</p>
  </li>
</ol>

<hr />

<p><strong>Dictionary</strong></p>
<ul>
  <li><strong>HSI/HSE</strong>: Internal/external clock sources.</li>
  <li><strong>PLL</strong>: Clock multiplier for higher frequencies.</li>
  <li><strong>SYSCLK</strong>: Primary system clock.</li>
  <li><strong>AHB/APB</strong>: Buses for peripherals and memory.</li>
  <li><strong>Prescaler</strong>: Divides clock frequency.</li>
</ul>

<hr />

<p><strong>Additional Resources</strong></p>
<ul>
  <li><a href="https://www.st.com/resource/en/application_note/dm00119316.pdf">STM32F4 Clock Configuration Guide</a></li>
  <li><a href="https://www.youtube.com/watch?v=u4zyptPLlJI">Oscilloscope Basics Tutorial</a></li>
</ul>

<hr />

<p><strong>Debugging</strong></p>
<ul>
  <li><strong>Issue</strong>: GPIO toggle is too slow.
    <ul>
      <li><strong>Fix</strong>: Verify <code class="language-text highlighter-rouge">SystemCoreClock</code> in <code class="language-text highlighter-rouge">system_stm32f4xx.c</code> is 168000000.</li>
    </ul>
  </li>
  <li><strong>Issue</strong>: Code crashes after clock configuration.
    <ul>
      <li><strong>Fix</strong>: Ensure <strong>Flash Latency</strong> is set to 5 wait states (required for 168 MHz).</li>
    </ul>
  </li>
  <li><strong>Issue</strong>: No signal on oscilloscope.
    <ul>
      <li><strong>Fix</strong>: Confirm GPIO pin is configured as output and oscilloscope ground is connected.</li>
    </ul>
  </li>
</ul>

<p>week 9 https://books-library.net/files/books-library.net-07281709Ee1R6.pdf</p>

<hr />

<h2 id="credits">Credits</h2>

<!--Written by Jorge Porras (2025)-->
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1">
      <p>Deepseek. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

</div>
</article>
  </main>

  <!-- _includes/footer.html -->
<footer class="site-footer">
  <div class="footer-content">
    <div class="social-links">
      <a href="https://github.com/yoon-zh" class="hover-glow" aria-label="GitHub">
        <i class="fab fa-github"></i>
      </a>
      <a href="mailto:yoon_zh@outlook.com" class="hover-glow" aria-label="Email">
        <i class="fas fa-envelope"></i>
      </a>
      <a href="https://www.linkedin.com/in/jorge-porras-1a7393282/" class="hover-glow" aria-label="LinkedIn">
        <i class="fab fa-linkedin"></i>
      </a>
      <a href="https://t.me/yo_o_n" class="hover-glow" aria-label="Telegram">
        <i class="fab fa-telegram-plane"></i>
      </a>
    </div>
    <div class="footer-bottom">
      <p>© 2025 윤志. All rights reserved.</p>
    </div>
  </div>
</footer>
<script src="/scripts/main.js"></script>
<script src="/scripts/codeblocks.js"></script>
<script src="/scripts/axeptio.js"></script>
</body>
</html>